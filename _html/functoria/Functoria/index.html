<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Functoria (functoria.Functoria)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../index.html">functoria</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Functoria</span></h1></header><p>The Functoria DSL.</p><p>The Functoria DSL allows users to describe how to create portable
and flexible applications. It allows to pass application
parameters easily using command-line arguments either at
configure-time or at runtime.</p><p>Users of the Functoria DSL composes their application by defining
a list of <a href="index.html#val-foreign">module</a> implementations, specify the
command-line <a href="index.html#keys">Keys</a> that are required and <a href="index.html#combinators">combine</a>
all of them together using
<a href="http://dx.doi.org/10.1017/S0956796807006326">applicative</a>
operators.</p><p>The DSL expression is then compiled into an <a href="index.html#app">application
builder</a>, which will, once evaluated, produced the final portable
and flexible application.</p><h2 id="combinators" class="anchored"><a href="#combinators" class="anchor"></a>Combinators</h2><div class="spec type" id="type-typ"><a href="#type-typ" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>_ typ</code><code></code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-typ.Type" class="anchored"><td class="def constructor"><a href="#type-typ.Type" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Type</span><span class="keyword"> : </span><span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-typ">typ</a></code></td></tr><tr id="type-typ.Function" class="anchored"><td class="def constructor"><a href="#type-typ.Function" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Function</span><span class="keyword"> : </span><span class="type-var">'b</span> <a href="index.html#type-typ">typ</a><span class="keyword"> * </span><span class="type-var">'c</span> <a href="index.html#type-typ">typ</a> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'b</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'c</span>) <a href="index.html#type-typ">typ</a></code></td></tr></table><code></code></div><div class="doc"><p>The type for values representing module types.</p></div></div><div class="spec val" id="val-typ"><a href="#val-typ" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>typ : <span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-typ">typ</a></code></div><div class="doc"><p><code class="code">type t</code> is a value representing the module type <code class="code">t</code>.</p></div></div><div class="spec val" id="val-(@-&gt;)"><a href="#val-(@-&gt;)" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>(@-&gt;) : <span class="type-var">'a</span> <a href="index.html#type-typ">typ</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="index.html#type-typ">typ</a> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span>) <a href="index.html#type-typ">typ</a></code></div><div class="doc"><p>Construct a functor type from a type and an existing functor
type. This corresponds to prepending a parameter to the list of
functor parameters. For example:</p><pre><code class="code">kv_ro @-&gt; ip @-&gt; kv_ro</code></pre><p>This describes a functor type that accepts two arguments -- a
<code class="code">kv_ro</code> and an <code class="code">ip</code> device -- and returns a <code class="code">kv_ro</code>.</p></div></div><div class="spec type" id="type-job"><a href="#type-job" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>job</code><code></code><code></code></div><div class="doc"><p>Type for job values.</p></div></div><div class="spec val" id="val-job"><a href="#val-job" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>job : <a href="index.html#type-job">job</a> <a href="index.html#type-typ">typ</a></code></div><div class="doc"><p><code class="code">job</code> is the signature for user's application main module.</p></div></div><div class="spec type" id="type-impl"><a href="#type-impl" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>'a impl</code><code></code><code></code></div><div class="doc"><p>The type for values representing module implementations.</p></div></div><div class="spec val" id="val-($)"><a href="#val-($)" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>($) : (<span class="type-var">'a</span> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span>) <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="index.html#type-impl">impl</a></code></div><div class="doc"><p><code class="code">m $ a</code> applies the functor <code class="code">m</code> to the module <code class="code">a</code>.</p></div></div><div class="spec type" id="type-abstract_impl"><a href="#type-abstract_impl" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>abstract_impl</code><code></code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-abstract_impl.Abstract" class="anchored"><td class="def constructor"><a href="#type-abstract_impl.Abstract" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">Abstract</span><span class="keyword"> : </span><span class="type-var">_</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-abstract_impl">abstract_impl</a></code></td></tr></table><code></code></div><div class="doc"><p>The type for abstract implementations.</p></div></div><div class="spec val" id="val-abstract"><a href="#val-abstract" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>abstract : <span class="type-var">_</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-abstract_impl">abstract_impl</a></code></div><div class="doc"><p><code class="code">abstract t</code> is <code class="code">t</code> but with its type variable abstracted. Useful
for dependencies.</p></div></div><h2 id="keys" class="anchored"><a href="#keys" class="anchor"></a>Keys</h2><div class="spec type" id="type-key"><a href="#type-key" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>key</code><code><span class="keyword"> = </span><a href="../Functoria_key/index.html#type-t">Functoria_key.t</a></code><code></code></div><div class="doc"><p>The type for command-line keys. See <a href="../Functoria_key/index.html#type-t">Functoria_key.t</a>.</p></div></div><div class="spec type" id="type-context"><a href="#type-context" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>context</code><code><span class="keyword"> = </span><a href="../Functoria_key/index.html#type-context">Functoria_key.context</a></code><code></code></div><div class="doc"><p>The type for keys' parsing context. See <a href="../Functoria_key/index.html#type-context">Functoria_key.context</a>.</p></div></div><div class="spec type" id="type-value"><a href="#type-value" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>'a value</code><code><span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/index.html#type-value">Functoria_key.value</a></code><code></code></div><div class="doc"><p>The type for values parsed from the command-line. See
<a href="../Functoria_key/index.html#type-value">Functoria_key.value</a>.</p></div></div><div class="spec val" id="val-if_impl"><a href="#val-if_impl" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>if_impl : bool <a href="index.html#type-value">value</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a></code></div><div class="doc"><p><code class="code">if_impl v impl1 impl2</code> is <code class="code">impl1</code> if <code class="code">v</code> is resolved to true and
<code class="code">impl2</code> otherwise.</p></div></div><div class="spec val" id="val-match_impl"><a href="#val-match_impl" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>match_impl : <span class="type-var">'b</span> <a href="index.html#type-value">value</a> <span class="keyword">&#8209;&gt;</span> default:<span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'b</span><span class="keyword"> * </span><span class="type-var">'a</span> <a href="index.html#type-impl">impl</a>) list <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a></code></div><div class="doc"><p><code class="code">match_impl v cases ~default</code> chooses the implementation amongst
<code class="code">cases</code> by matching the <code class="code">v</code>'s value. <code class="code">default</code> is chosen if no
value matches.</p></div></div><div class="spec module-type" id="module-type-KEY"><a href="#module-type-KEY" class="anchor"></a><div class="def module-type"><code><span class="keyword">module type </span>KEY : <span class="keyword">module type of </span><a href="../Functoria_key/index.html">Functoria_key</a><span class="keyword"> with </span><span class="keyword">type </span>'a <a href="index.html#module-type-KEY">KEY</a>.Arg.converter<span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/Arg/index.html#type-converter">Functoria_key.Arg.converter</a><span class="keyword"> and </span><span class="keyword">type </span>'a <a href="index.html#module-type-KEY">KEY</a>.Arg.t<span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/Arg/index.html#type-t">Functoria_key.Arg.t</a><span class="keyword"> and </span><span class="keyword">type </span><a href="index.html#module-type-KEY">KEY</a>.Arg.info<span class="keyword"> = </span><a href="../Functoria_key/Arg/index.html#type-info">Functoria_key.Arg.info</a><span class="keyword"> and </span><span class="keyword">type </span>'a <a href="index.html#module-type-KEY">KEY</a>.value<span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/index.html#type-value">Functoria_key.value</a><span class="keyword"> and </span><span class="keyword">type </span>'a <a href="index.html#module-type-KEY">KEY</a>.key<span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/index.html#type-key">Functoria_key.key</a><span class="keyword"> and </span><span class="keyword">type </span><a href="index.html#module-type-KEY">KEY</a>.t<span class="keyword"> = </span><a href="../Functoria_key/index.html#type-t">Functoria_key.t</a><span class="keyword"> and </span><span class="keyword">type </span><a href="index.html#module-type-KEY">KEY</a>.Set.t<span class="keyword"> = </span><a href="../Functoria_key/index.html#module-Set">Functoria_key.Set</a>.t<span class="keyword"> and </span><span class="keyword">type </span>'a <a href="index.html#module-type-KEY">KEY</a>.Alias.t<span class="keyword"> = </span><span class="type-var">'a</span> <a href="../Functoria_key/Alias/index.html#type-t">Functoria_key.Alias.t</a><span class="keyword"> and </span><span class="keyword">type </span><a href="index.html#module-type-KEY">KEY</a>.context<span class="keyword"> = </span><a href="../Functoria_key/index.html#type-context">Functoria_key.context</a></code></div><div class="doc"><p>The signature for run-time and configure-time command-line
keys.</p></div></div><h2 id="pkg" class="anchored"><a href="#pkg" class="anchor"></a>Package dependencies</h2><p>For specifying opam package dependencies, the type <a href="index.html#type-package">package</a> is used. It
consists of the opam package name, the ocamlfind names, and optional lower
and upper bounds. The version constraints are merged with other modules.</p><div class="spec type" id="type-package"><a href="#type-package" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>package</code><code></code><code><span class="keyword"> = </span><span class="keyword">private </span></code><code>{</code><table class="record"><tr id="type-package.opam" class="anchored"><td class="def field"><a href="#type-package.opam" class="anchor"></a><code>opam : string;</code></td></tr><tr id="type-package.build" class="anchored"><td class="def field"><a href="#type-package.build" class="anchor"></a><code>build : bool;</code></td></tr><tr id="type-package.ocamlfind" class="anchored"><td class="def field"><a href="#type-package.ocamlfind" class="anchor"></a><code>ocamlfind : Astring.String.Set.t;</code></td></tr><tr id="type-package.min" class="anchored"><td class="def field"><a href="#type-package.min" class="anchor"></a><code>min : string option;</code></td></tr><tr id="type-package.max" class="anchored"><td class="def field"><a href="#type-package.max" class="anchor"></a><code>max : string option;</code></td></tr></table><code>}</code><code></code></div><div class="doc"><p>The type of a package</p></div></div><div class="spec val" id="val-package"><a href="#val-package" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>package : ?&#8288;build:bool <span class="keyword">&#8209;&gt;</span> ?&#8288;sublibs:string list <span class="keyword">&#8209;&gt;</span> ?&#8288;ocamlfind:string list <span class="keyword">&#8209;&gt;</span> ?&#8288;min:string <span class="keyword">&#8209;&gt;</span> ?&#8288;max:string <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-package">package</a></code></div><div class="doc"><p><code class="code">package ~build ~sublibs ~ocamlfind ~min ~max opam</code> is a <code class="code">package</code>. <code class="code">Build</code>
indicates a build-time dependency only, defaults to <code class="code">false</code>. The ocamlfind
name is by default the same as <code class="code">opam</code>, you can specify <code class="code">~sublibs</code> to add
additional sublibraries (e.g. <code class="code">~sublibs:[&quot;mirage&quot;] &quot;foo&quot;</code> will result in the
findlib names <code class="code"> [&quot;foo&quot;; &quot;foo.mirage&quot;] </code>. In case the findlib name is
disjoint (or empty), use <code class="code">~ocamlfind</code>. Specifying both <code class="code">~ocamlfind</code> and
<code class="code">~sublibs</code> leads to an invalid argument. Version constraints are given as
<code class="code">min</code> (inclusive) and <code class="code">max</code> (exclusive).</p></div></div><h2 id="app" class="anchored"><a href="#app" class="anchor"></a>Application Builder</h2><p>Values of type <a href="index.html#type-impl">impl</a> are tied to concrete module implementation
with the <a href="index.html#val-foreign">foreign</a> construct. Module implementations of type
<a href="index.html#type-job">job</a> can then be <a href="../Functoria_app/Make/index.html#val-register">registered</a> into
an application builder. The builder is in charge if parsing the
command-line arguments and of generating code for the final
application. See <a href="../Functoria_app/index.html">Functoria_app</a> for details.</p><div class="spec val" id="val-foreign"><a href="#val-foreign" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>foreign : ?&#8288;packages:<a href="index.html#type-package">package</a> list <span class="keyword">&#8209;&gt;</span> ?&#8288;keys:<a href="index.html#type-key">key</a> list <span class="keyword">&#8209;&gt;</span> ?&#8288;deps:<a href="index.html#type-abstract_impl">abstract_impl</a> list <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-typ">typ</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a></code></div><div class="doc"><p><code class="code">foreign name typ</code> is the module <code class="code">name</code>, having the module type
<code class="code">typ</code>.</p><ul><li>If <code class="code">packages</code> is set, then the given packages are
installed before compiling the current application.</li><li>If <code class="code">keys</code> is set, use the given <a href="../Functoria_key/index.html#type-key">keys</a> to
parse at configure and runtime the command-line arguments
before calling <code class="code">name.connect</code>.</li><li>If <code class="code">deps</code> is set, the given list of <a href="index.html#type-abstract_impl">abstract</a>
implementations is added as data-dependencies: they will be
initialized before calling <code class="code">name.connect</code>.</li></ul><p>For a more flexible definition of packages, or for a custom configuration
step, see the <a href="class-type-configurable/index.html">configurable</a> class type and the <a href="index.html#val-foreign">foreign</a> class.</p></div></div><div class="spec module" id="module-Info"><a href="#module-Info" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Info/index.html">Info</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="doc"><p>Information about the final application.</p></div></div><div class="spec class-type" id="class-type-configurable"><a href="#class-type-configurable" class="anchor"></a><div class="def class-type"><code><span class="keyword">class type </span>'ty <a href="class-type-configurable/index.html">configurable</a> = <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"><p>Signature for configurable module implementations. A
<code class="code">configurable</code> is a module implementation which contains a runtime
state which can be set either at configuration time (by the
application builder) or at runtime, using command-line
arguments.</p></div></div><div class="spec val" id="val-impl"><a href="#val-impl" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>impl : <span class="type-var">'a</span> <a href="class-type-configurable/index.html">configurable</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a></code></div><div class="doc"><p><code class="code">impl c</code> is the implementation of the configurable <code class="code">c</code>.</p></div></div><div class="spec class" id="class-base_configurable"><a href="#class-base_configurable" class="anchor"></a><div class="def class"><code><span class="keyword">class </span><a href="class-base_configurable/index.html">base_configurable</a> : <span class="keyword">object</span> ... <span class="keyword">end</span></code></div><div class="doc"><p><code class="code">base_configurable</code> pre-defining many methods from the
<a href="class-type-configurable/index.html">configurable</a> class. To be used as follow:</p></div></div><div class="spec class" id="class-foreign"><a href="#class-foreign" class="anchor"></a><div class="def class"><code><span class="keyword">class </span>'a <a href="class-foreign/index.html">foreign</a> : ?&#8288;packages:<a href="index.html#type-package">package</a> list <span class="keyword">&#8209;&gt;</span> ?&#8288;keys:<a href="index.html#type-key">key</a> list <span class="keyword">&#8209;&gt;</span> ?&#8288;deps:<a href="index.html#type-abstract_impl">abstract_impl</a> list <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-typ">typ</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="class-type-configurable/index.html">configurable</a></code></div><div class="doc"><p>This class can be inherited to define a <a href="class-type-configurable/index.html">configurable</a> with an API
similar to <a href="index.html#val-foreign">foreign</a>.</p></div></div><h2>Sharing</h2><div class="spec val" id="val-hash"><a href="#val-hash" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>hash : <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> int</code></div><div class="doc"><p><code class="code">hash</code> is the hash function on implementations. FIXME(samoht)
expand on how it works.</p></div></div><div class="spec val" id="val-equal"><a href="#val-equal" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>equal : <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="index.html#type-impl">impl</a> <span class="keyword">&#8209;&gt;</span> bool</code></div><div class="doc"><p><code class="code">equal</code> is the equality over implementations.</p></div></div><div class="spec module" id="module-ImplTbl"><a href="#module-ImplTbl" class="anchor"></a><div class="def module"><code><span class="keyword">module </span>ImplTbl : Hashtbl.S<span class="keyword"> with </span><span class="keyword">type </span><a href="index.html#module-ImplTbl">ImplTbl</a>.key<span class="keyword"> = </span><a href="index.html#type-abstract_impl">abstract_impl</a></code></div><div class="doc"><p>Hashtbl of implementations.</p></div></div></body></html>